<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Tarefa</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Editar Tarefa</h1>
    </header>

    <main>
        <div id="message-container"></div>
        <div id="loading-spinner" style="text-align: center; margin-top: 2rem;">Carregando dados...</div>
        
        <section id="formulario-edicao" class="p-4" style="display: none;">
            <h2>Detalhes da Tarefa</h2>
            <form id="formulario-tarefa">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group"><label for="titulo-tarefa">Título da Tarefa:</label><input type="text" id="titulo-tarefa" required></div>
                    <div class="form-group"><label for="armador-tarefa">Armador:</label><select id="armador-tarefa" required></select></div>
                    <div class="form-group"><label for="embarcacao-tarefa">Embarcação:</label><select id="embarcacao-tarefa" required disabled></select></div>
                    <div class="form-group"><label for="solicitante-tarefa">Solicitante:</label><select id="solicitante-tarefa" required disabled></select></div>
                    <div class="form-group"><label for="porto-tarefa">Porto:</label><select id="porto-tarefa" required></select></div>
                    <div class="form-group"><label for="tipo-tarefa">Tipo da Tarefa:</label><select id="tipo-tarefa" required></select></div>
                    <div class="form-group"><label for="data-inicio-tarefa">Data de Início:</label><input type="date" id="data-inicio-tarefa" required></div>
                    <div class="form-group"><label for="protocolo-tarefa">Protocolo:</label><input type="text" id="protocolo-tarefa"></div>
                    <div class="form-group"><label for="status-tarefa">Status:</label><select id="status-tarefa" required><option value="Não Iniciado">Não Iniciado</option><option value="Andamento">Andamento</option><option value="Exigência">Exigência</option><option value="Finalizado">Finalizado</option></select></div>
                    <div class="form-group" id="data-fim-container" style="display: none;"><label for="data-fim-tarefa">Data do Fim:</label><input type="date" id="data-fim-tarefa"></div>
                    
                    <div class="form-group">
                        <label for="prioridade-tarefa">Prioridade:</label>
                        <select id="prioridade-tarefa">
                            <option value="Normal">Normal</option>
                            <option value="Alta">Alta</option>
                            <option value="Baixa">Baixa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="deadline-tarefa">Deadline:</label>
                        <input type="date" id="deadline-tarefa">
                    </div>

                    <div class="form-group md:col-span-2"><label for="observacoes-tarefa">Observações:</label><textarea id="observacoes-tarefa" rows="4"></textarea></div>
                    
                    <div class="form-group">
                        <label>Evidência Atual:</label>
                        <div id="evidencia-atual">N/A</div>
                        <label for="nova-evidencia">Anexar Nova Evidência:</label>
                        <input type="file" id="nova-evidencia" accept="image/*,.pdf">
                    </div>

                    <div class="form-group">
                        <label>Ofício Atual:</label>
                        <div id="oficio-atual">N/A</div>
                        <label for="novo-oficio">Anexar Novo Ofício:</label>
                        <input type="file" id="novo-oficio" accept="image/*,.pdf">
                    </div>

                    <div class="form-group">
                        <label for="taxa-paga-tarefa">Houve pagamento de taxa?</label>
                        <select id="taxa-paga-tarefa">
                            <option value="false">Não</option>
                            <option value="true">Sim</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 text-center"><button type="submit" class="button">Salvar Alterações</button></div>
                </div>
            </form>
        </section>
        
        <div class="nav-buttons">
            <a id="voltar-lista" href="lista-tarefas.html" class="button">Voltar para a Lista</a>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.js"></script>
    <script src="config.js"></script>
    <script src="auth-guard.js"></script>
    <script>
        const formulario = document.getElementById('formulario-tarefa');
        const loadingSpinner = document.getElementById('loading-spinner');
        const formularioEdicao = document.getElementById('formulario-edicao');
        const params = new URLSearchParams(window.location.search);
        const tarefaId = params.get('id');

        async function uploadArquivo(arquivo, pasta) {
            if (!arquivo) return null;
            const filePath = `${pasta}/${Date.now()}_${arquivo.name}`;
            const { error: uploadError } = await supabase_client.storage.from('storage').upload(filePath, arquivo);
            if (uploadError) throw new Error(`Erro no upload (${pasta}): ${uploadError.message}`);
            const { data: urlData } = supabase_client.storage.from('storage').getPublicUrl(filePath);
            return urlData.publicUrl;
        }

        (async function inicializarPagina() {
            if (!tarefaId) {
                loadingSpinner.textContent = 'ID da tarefa não encontrado.';
                return;
            }

            const armadorSelect = document.getElementById('armador-tarefa');
            const portoSelect = document.getElementById('porto-tarefa');
            const tipoTarefaSelect = document.getElementById('tipo-tarefa');
            const embarcacaoSelect = document.getElementById('embarcacao-tarefa');
            const solicitanteSelect = document.getElementById('solicitante-tarefa');
            const statusTarefaSelect = document.getElementById('status-tarefa');
            const dataFimContainer = document.getElementById('data-fim-container');
            
            async function popularDropdown(select, tabela) {
                const { data } = await supabase_client.from(tabela).select('id, nome').order('nome');
                select.innerHTML = '<option value="" disabled>Selecione</option>';
                data.forEach(item => select.add(new Option(item.nome, item.id)));
            }

            async function carregarDropdownsDependentes(armadorId) {
                embarcacaoSelect.disabled = true;
                solicitanteSelect.disabled = true;
                if (!armadorId) return;

                const { data: embarcacoes } = await supabase_client.from('embarcacoes').select('id, nome').eq('armador_id', armadorId).order('nome');
                embarcacaoSelect.innerHTML = '<option value="" disabled>Selecione</option>';
                embarcacoes.forEach(item => embarcacaoSelect.add(new Option(item.nome, item.id)));
                
                const { data: solicitantes } = await supabase_client.from('solicitantes').select('id, nome').eq('armador_id', armadorId).order('nome');
                solicitanteSelect.innerHTML = '<option value="" disabled>Selecione</option>';
                solicitantes.forEach(item => solicitanteSelect.add(new Option(item.nome, item.id)));
                
                embarcacaoSelect.disabled = false;
                solicitanteSelect.disabled = false;
            }

            armadorSelect.addEventListener('change', () => carregarDropdownsDependentes(armadorSelect.value));
            statusTarefaSelect.addEventListener('change', () => {
                dataFimContainer.style.display = (statusTarefaSelect.value === 'Finalizado') ? 'flex' : 'none';
            });

            await Promise.all([
                popularDropdown(armadorSelect, 'armadores'),
                popularDropdown(portoSelect, 'portos'),
                popularDropdown(tipoTarefaSelect, 'tipos_tarefa')
            ]);
            
            const { data: tarefa, error } = await supabase_client.from('tarefas').select('*').eq('id', tarefaId).single();
            if (error) { loadingSpinner.textContent = 'Erro ao carregar tarefa.'; return; }

            document.getElementById('titulo-tarefa').value = tarefa.titulo;
            document.getElementById('data-inicio-tarefa').value = tarefa.dataInicio;
            document.getElementById('protocolo-tarefa').value = tarefa.protocolo || '';
            statusTarefaSelect.value = tarefa.status;
            document.getElementById('data-fim-tarefa').value = tarefa.dataFim || '';
            document.getElementById('observacoes-tarefa').value = tarefa.observacoes || '';
            document.getElementById('prioridade-tarefa').value = tarefa.prioridade || 'Normal';
            document.getElementById('deadline-tarefa').value = tarefa.data_deadline;
            document.getElementById('taxa-paga-tarefa').value = tarefa.taxa_paga;
            
            portoSelect.value = tarefa.porto_id;
            armadorSelect.value = tarefa.armador_id;
            tipoTarefaSelect.value = tarefa.tipo_id;

            await carregarDropdownsDependentes(tarefa.armador_id);
            embarcacaoSelect.value = tarefa.embarcacao_id;
            solicitanteSelect.value = tarefa.solicitante_id;
            
            document.getElementById('evidencia-atual').innerHTML = tarefa.urlEvidencia ? `<a href="${tarefa.urlEvidencia}" target="_blank">Ver Evidência</a>` : 'N/A';
            document.getElementById('oficio-atual').innerHTML = tarefa.url_oficio ? `<a href="${tarefa.url_oficio}" target="_blank">Ver Ofício</a>` : 'N/A';
            
            if (tarefa.status === 'Finalizado') dataFimContainer.style.display = 'flex';

            loadingSpinner.style.display = 'none';
            formularioEdicao.style.display = 'block';
        })();

        formulario.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { data: tarefaAtual } = await supabase_client.from('tarefas').select('urlEvidencia, url_oficio').eq('id', tarefaId).single();
                if (!tarefaAtual) throw new Error("Tarefa original não encontrada para atualização.");

                const [urlEvidencia, urlOficio] = await Promise.all([
                    uploadArquivo(document.getElementById('nova-evidencia').files[0], 'prints'),
                    uploadArquivo(document.getElementById('novo-oficio').files[0], 'oficios')
                ]);
                
                const tarefaAtualizada = {
                    titulo: document.getElementById('titulo-tarefa').value,
                    armador_id: document.getElementById('armador-tarefa').value || null,
                    embarcacao_id: document.getElementById('embarcacao-tarefa').value || null,
                    solicitante_id: document.getElementById('solicitante-tarefa').value || null,
                    porto_id: document.getElementById('porto-tarefa').value || null,
                    tipo_id: document.getElementById('tipo-tarefa').value || null,
                    dataInicio: document.getElementById('data-inicio-tarefa').value || null,
                    protocolo: document.getElementById('protocolo-tarefa').value || null,
                    status: document.getElementById('status-tarefa').value,
                    dataFim: document.getElementById('data-fim-tarefa').value || null,
                    prioridade: document.getElementById('prioridade-tarefa').value,
                    data_deadline: document.getElementById('deadline-tarefa').value || null,
                    observacoes: document.getElementById('observacoes-tarefa').value || null,
                    taxa_paga: document.getElementById('taxa-paga-tarefa').value === 'true',
                    url_oficio: urlOficio !== null ? urlOficio : tarefaAtual.url_oficio,
                    urlEvidencia: urlEvidencia !== null ? urlEvidencia : tarefaAtual.urlEvidencia
                };

                const { error } = await supabase_client.from('tarefas').update(tarefaAtualizada).eq('id', tarefaId);
                if (error) throw error;
                
                localStorage.setItem('tarefaAtualizada', 'true');
                // Mantém o filtro ao voltar para a lista
                const armadorIdVolta = tarefaAtualizada.armador_id;
                document.getElementById('voltar-lista').href = `lista-tarefas.html?armadorId=${armadorIdVolta}&filtro=ativas`;
                window.location.href = `lista-tarefas.html?armadorId=${armadorIdVolta}&filtro=ativas`;

            } catch (error) {
                showMessage(`Erro ao atualizar: ${error.message}`, false);
                console.error(error);
            }
        });
    </script>
</body>
</html>