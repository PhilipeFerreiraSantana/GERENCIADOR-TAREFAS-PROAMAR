<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tarefas</title>
    <link rel="stylesheet" href="style.css?v=1.1"> 
</head>
<body>
    <header>
        <div id="lista-header" style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
            <img id="logo-armador-img-lista" src="" alt="Logo do Armador" style="height: 60px; display: none; border-radius: 8px;">
            <h1 id="titulo-lista">Carregando Tarefas...</h1>
        </div>
    </header>
    <main>
        <div id="message-container"></div>
        <section id="lista-tarefas-section">
            <div id="loading-spinner">Carregando...</div>
            <div id="tarefas-container"></div>
        </section>
        <div class="nav-buttons">
            <a id="botao-voltar" href="index.html" class="button">Voltar</a>
        </div>
    </main>
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <p>Tem certeza que quer marcar esta tarefa como excluída?</p>
            <div class="modal-buttons">
                <button id="confirm-yes" class="button excluir-button">Sim</button>
                <button id="confirm-no" class="button alterar-button">Não</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.0/dist/umd/supabase.js"></script>
    <script src="config.js"></script>
    <script src="auth-guard.js"></script>
    <script src="user-display.js"></script>
    <script>
        const loadingSpinner = document.getElementById('loading-spinner');
        const tarefasContainer = document.getElementById('tarefas-container');
        const tituloLista = document.getElementById('titulo-lista');
        const botaoVoltar = document.getElementById('botao-voltar');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmYes = document.getElementById('confirm-yes');
        const confirmNo = document.getElementById('confirm-no');
        let tarefaIdParaExcluir = null;

        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            const data = new Date(dataString);
            if (isNaN(data.getTime())) return 'N/A';
            data.setMinutes(data.getMinutes() + data.getTimezoneOffset());
            return data.toLocaleDateString('pt-BR');
        }

        async function carregarTarefasFiltradas() {
            loadingSpinner.style.display = 'block';
            tarefasContainer.innerHTML = '';
            const params = new URLSearchParams(window.location.search);
            const armadorId = parseInt(params.get('armadorId'), 10);
            const armadorNome = params.get('armadorNome');
            const logoUrl = params.get('logoUrl');
            const filtro = params.get('filtro');
            const { data: { user } } = await supabase_client.auth.getUser();

            if (!filtro || !user) { loadingSpinner.textContent = "Erro: Filtro ou Usuário inválido."; return; }

            if (filtro === 'minhas_ativas' || filtro === 'pendencias') {
                botaoVoltar.href = 'selecionar-armador.html';
            } else {
                botaoVoltar.href = `dashboard-armador.html?armadorId=${armadorId}&armadorNome=${encodeURIComponent(armadorNome)}&logoUrl=${encodeURIComponent(logoUrl)}`;
            }
            if (logoUrl && logoUrl !== 'null' && logoUrl !== '' && filtro !== 'minhas_ativas' && filtro !== 'pendencias') {
                document.getElementById('logo-armador-img-lista').src = logoUrl;
                document.getElementById('logo-armador-img-lista').style.display = 'block';
            }

            let query = supabase_client.from('tarefas').select(`*, portos(nome), profiles(alias), embarcacoes(nome)`);
            const hoje = new Date().toISOString();

            switch (filtro) {
                case 'ativas':
                    tituloLista.textContent = `Tarefas Ativas (${armadorNome})`;
                    query = query.eq('armador_id', armadorId).eq('esta_excluida', false).neq('status', 'Finalizado');
                    break;
                case 'finalizadas':
                    tituloLista.textContent = `Tarefas Finalizadas (${armadorNome})`;
                    query = query.eq('armador_id', armadorId).eq('status', 'Finalizado').eq('esta_excluida', false);
                    break;
                case 'excluidas':
                    tituloLista.textContent = `Tarefas Excluídas (${armadorNome})`;
                    query = query.eq('armador_id', armadorId).eq('esta_excluida', true);
                    break;
                case 'pendencias':
                    tituloLista.textContent = "Minhas Pendências";
                    const pendenciasFiltro = [`data_deadline.lt.${hoje}`, 'prioridade.eq.Alta', 'urlEvidencia.is.null', 'protocolo.is.null', 'url_oficio.is.null', 'taxa_paga.eq.false'].join(',');
                    query = query.eq('user_id', user.id).eq('esta_excluida', false).neq('status', 'Finalizado').or(pendenciasFiltro);
                    break;
                case 'minhas_ativas':
                    tituloLista.textContent = "Minhas Tarefas Ativas";
                    query = query.eq('user_id', user.id).eq('esta_excluida', false).neq('status', 'Finalizado');
                    break;
                default:
                    loadingSpinner.textContent = "Filtro desconhecido."; return;
            }

            const { data: tarefas, error } = await query
                .order('prioridade', { ascending: true })
                .order('data_deadline', { ascending: true, nullsfirst: false });

            if (error) { loadingSpinner.textContent = "Erro ao buscar tarefas."; console.error(error); return; }
            renderizarTarefas(tarefas, filtro);
        }

        function renderizarTarefas(tarefas, filtro) {
            loadingSpinner.style.display = 'none';
            tarefasContainer.innerHTML = '';

            if (!tarefas || tarefas.length === 0) {
                tarefasContainer.innerHTML = '<p style="text-align: center;">Nenhuma tarefa encontrada.</p>';
                return;
            }

            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-responsive-container';

            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Cód.</th>
                        <th>Porto</th>
                        <th>Navio</th>
                        <th>Título</th>
                        <th>Status</th>
                        <th>Responsável</th>
                        <th>Deadline</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    ${tarefas.map(t => `
                        <tr>
                            <td>${t.codigo ? t.codigo.slice(-4) : 'N/A'}</td>
                            <td>${t.portos ? t.portos.nome : 'N/A'}</td>
                            <td>${t.embarcacoes ? t.embarcacoes.nome : 'N/A'}</td>
                            <td><a href="detalhar-tarefa.html?id=${t.id}" class="detalhe-link">${t.titulo ? t.titulo.toUpperCase() : ''}</a></td>
                            <td>${t.status}</td>
                            <td>${t.profiles ? t.profiles.alias : 'N/A'}</td>
                            <td>${formatarData(t.data_deadline)}</td>
                            <td class="actions-cell">
                                <a href="editar-tarefa.html?id=${t.id}" class="action-button alterar-button">Alterar</a>
                                ${filtro !== 'excluidas' ? `<button class="action-button excluir-button" data-id="${t.id}">Excluir</button>` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            tableContainer.appendChild(table);
            tarefasContainer.appendChild(tableContainer);
        }

        tarefasContainer.addEventListener('click', (e) => {
            const targetButton = e.target.closest('.excluir-button');
            if (targetButton) { 
                tarefaIdParaExcluir = targetButton.dataset.id; 
                if (confirmModal) confirmModal.style.display = 'block'; 
            }
        });

        confirmYes.addEventListener('click', async () => {
            if (tarefaIdParaExcluir) {
                const { error } = await supabase_client.from('tarefas').update({ esta_excluida: true }).eq('id', tarefaIdParaExcluir);
                if (error) { 
                    showMessage(`Erro ao excluir: ${error.message}`, false); 
                } else { 
                    showMessage("Tarefa marcada como excluída.", true); 
                    carregarTarefasFiltradas(); 
                }
            }
            if (confirmModal) confirmModal.style.display = 'none';
            tarefaIdParaExcluir = null;
        });

        confirmNo.addEventListener('click', () => { 
            if (confirmModal) confirmModal.style.display = 'none'; 
            tarefaIdParaExcluir = null; 
        });
        
        // =================================================================
        // INÍCIO: CORREÇÃO DA MENSAGEM DE SUCESSO
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            const successMessage = localStorage.getItem('successMessage');
            if (successMessage) {
                showMessage(successMessage, true);
                localStorage.removeItem('successMessage'); // Limpa a mensagem para não exibir de novo
            }
            carregarTarefasFiltradas();
        });
        // ===============================================================
        // FIM: CORREÇÃO
        // ===============================================================
    </script>
</body>
</html>